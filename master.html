<!-- MASTER_COMPACT_V2 -->
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Il Custode - Modalit√† Master</title>
  <style>
    :root{ --legno:#4b3621; --pelle:#d2b48c; --pelle-scura:#c2a178; --inchiostro:#3e2f1c; }
    *{ box-sizing:border-box }
    html,body{ height:100%; }
    body{
      font-family:'Papyrus', fantasy; margin:0; padding:0; color:var(--inchiostro); text-align:center;
      background:
        radial-gradient(80% 60% at 50% 40%, rgba(0,0,0,.06), transparent 70%),
        url('../assets/sfondo-pergamena-decor.svg') no-repeat center center fixed;
      background-size:cover;
      overflow-anchor:none;
    }
    .cornice{
      border:40px solid transparent;
      -webkit-border-image:url('../assets/cornice-legno.svg') 40 stretch;
      border-image:url('../assets/cornice-legno.svg') 40 stretch;
      min-height:100vh; display:flex; flex-direction:column;
    }
    header{
      position:relative; background-color:rgba(75,54,33,.85); color:#fff8dc; padding:14px 20px;
      border-bottom:5px solid var(--legno); display:flex; align-items:center; justify-content:center; gap:10px; font-size:26px;
      /* spazio di sicurezza perch√© il pulsante Indietro viene iniettato a sinistra */
      padding-left:80px;
    }
    /* NIENTE .back-btn qui: lo aggiunge main.js */

    #userBadge{ position:absolute; right:120px; font-size:14px; opacity:.9; }
    #headerLogout{ position:absolute; right:20px; background:var(--pelle); border:3px solid var(--legno); padding:6px 10px; border-radius:8px; cursor:pointer; }
    #headerLogout:hover{ background:var(--pelle-scura); }

    .container{
      width:100%; max-width:1100px; margin:0 auto; padding:18px 14px 24px;
      text-align:left;
    }

    .grid-2{ display:grid; gap:14px; grid-template-columns:1fr; }
    @media(min-width:960px){ .grid-2{ grid-template-columns:1fr 1fr; } }

    .panel{
      background:rgba(255,248,220,.92); border:3px solid var(--legno); border-radius:12px; padding:16px;
      box-shadow:0 4px 10px rgba(0,0,0,.12);
    }
    h3{ margin:0 0 10px; }
    .row{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    input[type="text"], input[type="email"], input[type="password"]{
      flex:1 1 260px; padding:10px; border:2px solid var(--legno); border-radius:8px; font-size:16px; font-family:'Papyrus', fantasy; background:#fffdf3;
    }
    button{
      background:var(--pelle); border:3px solid var(--legno); padding:8px 12px; font-size:16px; font-family:'Papyrus', fantasy; cursor:pointer; border-radius:10px;
    }
    button:hover{ background:var(--pelle-scura); }
    .muted{ opacity:.9; font-size:14px; }

    #campDetail{ display:none; }
    .pin-box{ display:inline-block; font-weight:bold; letter-spacing:2px; padding:6px 10px; border:3px solid var(--legno); border-radius:8px; background:#fffef5; }
  </style>
</head>
<body>
<div class="cornice">
  <header>
    üé© Modalit√† Master
    <span id="userBadge"></span>
    <button id="headerLogout" hidden>Logout</button>
  </header>

  <div class="container">
    <!-- LOGIN CLOUD (Supabase) -->
    <section id="supaPanel" class="panel">
      <h3>Accedi con il tuo account</h3>
      <div class="row">
        <input id="supEmail" type="email" placeholder="Email" />
        <input id="supPass"  type="password" placeholder="Password" />
        <button id="supSignIn">Login</button>
        <button id="supSignUp">Registrati</button>
        <button id="supSignOut" style="display:none;">Esci</button>
      </div>
      <div class="muted" id="supStatus"></div>
    </section>

    <!-- DASHBOARD (dopo login) -->
    <section id="dashboard" style="display:none;">
      <!-- ALTO: Campagne -->
      <div class="grid-2">
        <section class="panel">
          <h3>Le tue campagne</h3>
          <p class="muted">Gestisci campagne, codici di ingresso e condivisione con i giocatori.</p>
          <button id="openCampPage">Apri gestione campagne</button>
        </section>

        <section class="panel">
          <h3>Crea nuova campagna</h3>
          <div class="row">
            <input id="campName" type="text" placeholder="Nome campagna (es. La Leggenda di Zardruul)">
            <button id="newCampBtn">Crea</button>
          </div>
          <div id="newCampStatus" class="muted"></div>
        </section>
      </div>

      <!-- BASSO: Mappe + Homebrew -->
      <div class="grid-2" style="margin-top:14px;">
        <section class="panel">
          <h3>Mappe</h3>
          <p class="muted">Genera nuove mappe procedurali. Le mappe salvate vivranno dentro ogni campagna.</p>
          <button id="openMapGen">Generatore di mappe</button>
        </section>

        <section class="panel">
          <h3>Homebrew</h3>
          <p class="muted">Mostri, tesori, incontri, tabelle personalizzate. Salvate sul tuo profilo Master.</p>
          <button id="openHomebrew">Apri Homebrew</button>
        </section>
      </div>

      <!-- Dettaglio compatto dopo creazione -->
      <section id="campDetail" class="panel" style="margin-top:14px;">
        <h3 id="campTitle">Campagna creata</h3>
        <div class="row">
          <div class="muted">PIN iniziale:</div>
          <div id="pinBox" class="pin-box">------</div>
          <button id="copyPinBtn">Copia PIN</button>
        </div>
        <div class="muted" id="campStatus"></div>
      </section>
    </section>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = 'https://djxxfzhvnejogcijpbtu.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRqeHhmemh2bmVqb2djaWpwYnR1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5ODkzNDEsImV4cCI6MjA3MDU2NTM0MX0.h3OJPo--ovVCYsPmX4g2LUVsK9npecTeAgr5u4by_-k';
const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const $ = (s)=>document.querySelector(s);
const supaPanel=$('#supaPanel'), supEmail=$('#supEmail'), supPass=$('#supPass');
const supSignIn=$('#supSignIn'), supSignUp=$('#supSignUp'), supSignOut=$('#supSignOut'), supStatus=$('#supStatus');
const userBadge=$('#userBadge'), headerLogout=$('#headerLogout');

const dashboard=$('#dashboard');
const campName=$('#campName'), newCampBtn=$('#newCampBtn'), newCampStatus=$('#newCampStatus');
const campDetail=$('#campDetail'), campTitle=$('#campTitle'), pinBox=$('#pinBox'), copyPinBtn=$('#copyPinBtn');

const LS_KEY_CAMPS='custode.master.campaigns';
function loadCamps(){ try{ return JSON.parse(localStorage.getItem(LS_KEY_CAMPS)||'[]'); }catch{ return []; } }
function saveCamps(a){ try{ localStorage.setItem(LS_KEY_CAMPS, JSON.stringify(a)); }catch{} }
function uid(){ return (crypto.randomUUID?crypto.randomUUID():(Date.now().toString(36)+Math.random().toString(36).slice(2))); }

async function refreshBySession(){
  const { data } = await supabaseClient.auth.getSession();
  if (data && data.session){
    const email = data.session.user?.email || '';
    supStatus.textContent = 'Sei autenticato.';
    supaPanel.style.display='none'; dashboard.style.display='';
    userBadge.textContent = email ? `Connesso come: ${email}` : '';
    headerLogout.hidden=false; supSignOut.style.display='';
  } else {
    supStatus.textContent = 'Accedi o registrati per continuare.';
    supaPanel.style.display=''; dashboard.style.display='none';
    userBadge.textContent=''; headerLogout.hidden=true; supSignOut.style.display='none';
  }
}

supSignIn.addEventListener('click', async ()=>{
  const email=(supEmail.value||'').trim(), pass=(supPass.value||'').trim();
  if(!email||!pass){ supStatus.textContent='Inserisci email e password.'; return; }
  supStatus.textContent='Accesso in corso‚Ä¶';
  const { error } = await supabaseClient.auth.signInWithPassword({ email, password:pass });
  if(error){ supStatus.textContent='Errore login: '+error.message; return; }
  supStatus.textContent='Login riuscito.'; refreshBySession();
});
supSignUp.addEventListener('click', async ()=>{
  const email=(supEmail.value||'').trim(), pass=(supPass.value||'').trim();
  if(!email||!pass){ supStatus.textContent='Inserisci email e password.'; return; }
  supStatus.textContent='Registrazione‚Ä¶';
  const { error } = await supabaseClient.auth.signUp({ email, password:pass });
  if(error){ supStatus.textContent='Errore registrazione: '+error.message; return; }
  supStatus.textContent='Registrato! Controlla l‚Äôemail (se richiesta) e poi fai Login.';
});
[supSignOut, headerLogout].forEach(btn=>btn.addEventListener('click', async ()=>{
  await supabaseClient.auth.signOut(); refreshBySession();
}));

newCampBtn.addEventListener('click', ()=>{
  const name=(campName.value||'').trim();
  if(!name){ newCampStatus.textContent='Inserisci un nome.'; return; }
  const arr=loadCamps();
  const camp={ id:uid(), name, pin:String(Math.floor(100000+Math.random()*900000)), createdAt:Date.now(), shared:false };
  arr.push(camp); saveCamps(arr); campName.value=''; newCampStatus.textContent='Campagna creata.';
  campTitle.textContent=`Campagna: ${camp.name}`; pinBox.textContent=camp.pin; campDetail.style.display='';
  setTimeout(()=>newCampStatus.textContent='',1200);
});
copyPinBtn.addEventListener('click', ()=>{ const t=pinBox.textContent||''; if(!t||t==='------')return; navigator.clipboard.writeText(t); const s=$('#campStatus'); if(s){ s.textContent='PIN copiato.'; setTimeout(()=>s.textContent='',1000); }});

$('#openCampPage').addEventListener('click', ()=>{ location.href='campaigns.html'; });
$('#openMapGen').addEventListener('click', ()=>{ location.href='map-generator.html'; });
$('#openHomebrew').addEventListener('click', ()=>{ location.href='homebrew.html'; });

refreshBySession();
</script>
</body>
</html>