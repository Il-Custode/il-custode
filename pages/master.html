<!-- MASTER (/pages) — senza login; i18n “safe”, singleton Supabase e guard -->
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title data-i18n="master.page_title">Il Custode — Modalità Master</title>
  <style>
    :root{ --legno:#4b3621; --pelle:#d2b48c; --pelle-scura:#c2a178; --inchiostro:#3e2f1c; --pergamena:#fff3d4; }
    *{ box-sizing:border-box }
    html,body{ height:100%; }
    body{
      font-family:'Papyrus', fantasy; margin:0; padding:0; color:var(--inchiostro); text-align:center;
      background:
        radial-gradient(80% 60% at 50% 40%, rgba(0,0,0,.06), transparent 70%),
        url('../assets/sfondo-pergamena-decor.svg') no-repeat center center fixed;
      background-size:cover; overflow-anchor:none;
    }
    .cornice{
      border:40px solid transparent;
      -webkit-border-image:url('../assets/cornice-legno.svg') 40 stretch;
      border-image:url('../assets/cornice-legno.svg') 40 stretch;
      min-height:100vh; display:flex; flex-direction:column;
      background: linear-gradient(180deg, rgba(255,243,212,.30), rgba(255,243,212,.15));
    }
    header{
      position:relative; background-color:rgba(75,54,33,.85); color:#fff8dc; padding:14px 20px;
      border-bottom:5px solid var(--legno); display:flex; align-items:center; justify-content:center; gap:10px; font-size:26px;
      padding-left:80px; /* spazio per eventuale back iniettato altrove */
    }
    #userBadge{ position:absolute; right:120px; font-size:14px; opacity:.9; white-space:nowrap; }
    #headerLogout{
      position:absolute; right:20px; background:var(--pelle); border:3px solid var(--legno); padding:6px 10px; border-radius:8px; cursor:pointer;
    }
    #headerLogout:hover{ background:var(--pelle-scura); }

    .container{ width:100%; max-width:1100px; margin:0 auto; padding:18px 14px 24px; text-align:left; }
    .grid-2{ display:grid; gap:14px; grid-template-columns:1fr; }
    @media(min-width:960px){ .grid-2{ grid-template-columns:1fr 1fr; } }
    .panel{
      background:rgba(255,248,220,.92); border:3px solid var(--legno); border-radius:12px; padding:16px;
      box-shadow:0 4px 10px rgba(0,0,0,.12);
    }
    h3{ margin:0 0 10px; }
    .row{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    input[type="text"]{
      flex:1 1 260px; padding:10px; border:2px solid var(--legno); border-radius:8px; font-size:16px; font-family:'Papyrus', fantasy; background:#fffdf3;
    }
    button{
      background:var(--pelle); border:3px solid var(--legno); padding:8px 12px; font-size:16px; font-family:'Papyrus', fantasy; cursor:pointer; border-radius:10px;
    }
    button:hover{ background:var(--pelle-scura); }
    .muted{ opacity:.9; font-size:14px; }

    #campDetail{ display:none; }
    .pin-box{ display:inline-block; font-weight:bold; letter-spacing:2px; padding:6px 10px; border:3px solid var(--legno); border-radius:8px; background:#fffef5; }
  </style>

  <!-- i18n deve venire prima di chi lo usa -->
  <script src="../assets/js/i18n.js"></script>

  <!-- CONFIG SUPABASE (globale) -->
  <script>
    window.SUPABASE_URL = 'https://djxxfzhvnejogcijpbtu.supabase.co';
    window.SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRqeHhmemh2bmVqb2djaWpwYnR1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5ODkzNDEsImV4cCI6MjA3MDU2NTM0MX0.h3OJPo--ovVCYsPmX4g2LUVsK9npecTeAgr5u4by_-k';
    document.dispatchEvent(new Event('supabase:set-config'));
  </script>

  <!-- SINGLETON (unico client per tutta l’app) -->
  <script src="../assets/js/supabase-singleton.js"></script>
</head>
<body>
<div class="cornice">
  <header>
    🎩 <span id="hdrTitle" data-i18n="master.title_short">Modalità Master</span>
    <span id="userBadge"></span>
    <button id="headerLogout" data-role="logout" data-i18n="common.logout">Logout</button>
  </header>

  <div class="container">
    <!-- DASHBOARD -->
    <section id="dashboard">
      <div class="grid-2">
        <!-- 1) Le tue campagne -->
        <section class="panel">
          <h3 id="capTitle" data-i18n="master.dashboard.campaigns.title">Le tue campagne</h3>
          <p class="muted" id="capDesc" data-i18n="master.dashboard.campaigns.desc">Gestisci campagne, codici di ingresso e condivisione con i giocatori.</p>
          <button id="openCampPage" data-i18n="master.dashboard.campaigns.open">Apri gestione campagne</button>
        </section>

        <!-- 2) Crea nuova campagna -->
        <section class="panel">
          <h3 id="newTitle" data-i18n="master.dashboard.new.title">Crea nuova campagna</h3>
          <div class="row">
            <input id="campName" type="text" placeholder="Nome campagna (es. La Leggenda di Zardruul)" data-i18n-placeholder="master.dashboard.new.placeholder">
            <button id="newCampBtn" data-i18n="master.dashboard.new.create">Crea</button>
          </div>
          <div id="newCampStatus" class="muted"></div>
        </section>
      </div>

      <div class="grid-2" style="margin-top:14px;">
        <!-- 3) Mappe -->
        <section class="panel">
          <h3 id="mapsTitle" data-i18n="master.dashboard.bottom.maps.title">Mappe</h3>
          <p class="muted" id="mapsDesc" data-i18n="master.dashboard.bottom.maps.desc">Genera nuove mappe procedurali. Le mappe salvate vivranno dentro ogni campagna.</p>
          <button id="openMapGen" data-i18n="master.dashboard.bottom.maps.open">Generatore di mappe</button>
        </section>

        <!-- 4) Homebrew -->
        <section class="panel">
          <h3 id="hbTitle" data-i18n="master.dashboard.bottom.homebrew.title">Homebrew</h3>
          <p class="muted" id="hbDesc" data-i18n="master.dashboard.bottom.homebrew.desc">Mostri, tesori, incontri, tabelle personalizzate. Salvate sul tuo profilo Master.</p>
          <button id="openHomebrew" data-i18n="master.dashboard.bottom.homebrew.open">Apri Homebrew</button>
        </section>
      </div>

      <!-- Dettaglio -->
      <section id="campDetail" class="panel" style="margin-top:14px;">
        <h3 id="campTitle" data-i18n="master.detail.created.title">Campagna creata</h3>
        <div class="row">
          <div class="muted" id="pinLabel" data-i18n="master.detail.pin.label">PIN iniziale:</div>
          <div id="pinBox" class="pin-box">------</div>
          <button id="copyPinBtn" data-i18n="master.detail.pin.copy">Copia PIN</button>
        </div>
        <div class="muted" id="campStatus"></div>
      </section>
    </section>
  </div>
</div>

<script>
(() => {
  // ===== Attendi il client dal singleton =====
  async function waitForSupabase(timeoutMs=8000){
    const t0=Date.now();
    while(!window.supabaseClient){
      await new Promise(r=>setTimeout(r,50));
      if(Date.now()-t0>timeoutMs) throw new Error('Supabase non inizializzato');
    }
    return window.supabaseClient;
  }
  let supabaseClient;

  // ===== Helpers =====
  const $ = (s)=>document.querySelector(s);

  // i18n “safe”
  function tSafe(key, fallback) {
    try {
      if (!window.i18n || typeof window.i18n.t!=='function') return fallback;
      const v = window.i18n.t(key);
      if (!v || typeof v!=='string' || v.trim()===key.trim()) return fallback;
      return v;
    } catch { return fallback; }
  }
  function setText(id, key, fb) {
    const el = document.getElementById(id); if (!el) return;
    const val = tSafe(key, fb);
    if (!el.textContent || el.textContent.trim()==='' || el.dataset.lock!=='1') el.textContent = val;
  }
  function setPlaceholder(id, key, fb) {
    const el = document.getElementById(id); if (!el) return;
    const val = tSafe(key, fb);
    if (!el.getAttribute('placeholder')) el.setAttribute('placeholder', val);
  }

  // ===== Elements =====
  const userBadge=$('#userBadge'), headerLogout=$('#headerLogout');
  const newCampBtn=$('#newCampBtn'), campName=$('#campName'), newCampStatus=$('#newCampStatus');
  const campDetail=$('#campDetail'), pinBox=$('#pinBox'), copyPinBtn=$('#copyPinBtn');

  // ===== i18n Apply =====
  function applyI18nSafe(){
    window.i18n?.apply?.(document);
    document.title = tSafe('master.page_title', 'Il Custode — Modalità Master');
    setText('hdrTitle','master.title_short','Modalità Master');

    setText('capTitle','master.dashboard.campaigns.title','Le tue campagne');
    setText('capDesc','master.dashboard.campaigns.desc','Gestisci campagne, codici di ingresso e condivisione con i giocatori.');
    setText('openCampPage','master.dashboard.campaigns.open','Apri gestione campagne');

    setText('newTitle','master.dashboard.new.title','Crea nuova campagna');
    setPlaceholder('campName','master.dashboard.new.placeholder','Nome campagna (es. La Leggenda di Zardruul)');
    setText('newCampBtn','master.dashboard.new.create','Crea');

    setText('mapsTitle','master.dashboard.bottom.maps.title','Mappe');
    setText('mapsDesc','master.dashboard.bottom.maps.desc','Genera nuove mappe procedurali. Le mappe salvate vivranno dentro ogni campagna.');
    setText('openMapGen','master.dashboard.bottom.maps.open','Generatore di mappe');

    setText('hbTitle','master.dashboard.bottom.homebrew.title','Homebrew');
    setText('hbDesc','master.dashboard.bottom.homebrew.desc','Mostri, tesori, incontri, tabelle personalizzate. Salvate sul tuo profilo Master.');
    setText('openHomebrew','master.dashboard.bottom.homebrew.open','Apri Homebrew');

    setText('campTitle','master.detail.created.title','Campagna creata');
    setText('pinLabel','master.detail.pin.label','PIN iniziale:');
    setText('copyPinBtn','master.detail.pin.copy','Copia PIN');

    if (headerLogout){
      headerLogout.textContent = tSafe('common.logout','Logout');
      headerLogout.title = tSafe('common.logout','Logout');
    }

    try {
      const lang = (window.i18n?.getLang && window.i18n.getLang()) || localStorage.getItem('custode.lang') || 'it';
      document.documentElement.setAttribute('lang', lang);
    } catch {}
  }

  // ===== Sessione / badge =====
  function setConnectedBadge(email){
    const prefix = tSafe('common.connected_as','Connesso come:');
    userBadge.textContent = email ? `${prefix} ${email}` : '';
  }

  async function guardSession(){
    try{
      const { data:{ session } = {} } = await supabaseClient.auth.getSession();
      if (!session){
        try { location.replace('../index.html'); } catch { location.href = '../index.html'; }
        return false;
      }
      setConnectedBadge(session.user?.email || '');
      return true;
    }catch{
      try { location.replace('../index.html'); } catch { location.href = '../index.html'; }
      return false;
    }
  }

  // ===== Logout (preserva “ricordami”) =====
  async function doLogout(){
    try { await supabaseClient.auth.signOut(); } catch {}
    try{
      const keepRemember = localStorage.getItem('custode.remember.on') === '1';
      const keepEmail    = localStorage.getItem('custode.remember.email') || '';
      const keepPass     = localStorage.getItem('custode.remember.pass') || '';
      const keys=[]; for(let i=0;i<localStorage.length;i++){ const k=localStorage.key(i); if(k) keys.push(k); }
      keys.forEach(k=>{
        if (k.startsWith('custode.') || k.startsWith('sb-')) localStorage.removeItem(k);
      });
      if (keepRemember){
        localStorage.setItem('custode.remember.on','1');
        localStorage.setItem('custode.remember.email', keepEmail);
        localStorage.setItem('custode.remember.pass',  keepPass);
      }
      sessionStorage.clear();
    }catch{}
    try { location.replace('../index.html'); } catch { location.href = '../index.html'; }
  }
  headerLogout.addEventListener('click', doLogout);

  // ===== Campagne (localStorage) =====
  const LS_KEY_CAMPS='custode.master.campaigns';
  function loadCamps(){ try{ return JSON.parse(localStorage.getItem(LS_KEY_CAMPS)||'[]'); }catch{ return []; } }
  function saveCamps(a){ try{ localStorage.setItem(LS_KEY_CAMPS, JSON.stringify(a)); }catch{} }
  function uid(){ return (crypto.randomUUID?crypto.randomUUID():(Date.now().toString(36)+Math.random().toString(36).slice(2))); }

  function wireCampaigns(){
    document.getElementById('newCampBtn').addEventListener('click', ()=>{
      const name=(document.getElementById('campName').value||'').trim();
      if(!name){ newCampStatus.textContent = tSafe('master.dashboard.new.need_name','Inserisci un nome.'); return; }
      const arr=loadCamps();
      const camp={ id:uid(), name, pin:String(Math.floor(100000+Math.random()*900000)), createdAt:Date.now(), shared:false };
      arr.push(camp); saveCamps(arr); document.getElementById('campName').value='';
      newCampStatus.textContent = tSafe('master.dashboard.new.created','Campagna creata.');

      const prefix = tSafe('master.detail.created.title_prefix','Campagna:');
      document.getElementById('campTitle').textContent = `${prefix} ${camp.name}`;
      pinBox.textContent=camp.pin; document.getElementById('campDetail').style.display='';
      setTimeout(()=>newCampStatus.textContent='',1200);
    });

    document.getElementById('copyPinBtn').addEventListener('click', ()=>{
      const t=pinBox.textContent||''; if(!t||t==='------')return;
      navigator.clipboard.writeText(t);
      const s=document.getElementById('campStatus');
      if(s){ s.textContent = tSafe('master.detail.pin.copied','PIN copiato.'); setTimeout(()=>s.textContent='',1000); }
    });

    // Navigazione (file nella stessa cartella /pages)
    document.getElementById('openCampPage').addEventListener('click', ()=>{ location.href='./campaigns.html'; });
    document.getElementById('openMapGen').addEventListener('click', ()=>{ location.href='./map-generator.html'; });
    document.getElementById('openHomebrew').addEventListener('click', ()=>{ location.href='./hub.html'; });
  }

  // ===== Hook i18n =====
  document.addEventListener('i18n:change', ()=>{ applyI18nSafe(); });

  // ===== Avvio =====
  (async function boot(){
    applyI18nSafe();
    try{
      supabaseClient = await waitForSupabase();
      console.log('✅ Supabase pronto:', !!window.supabaseClient);
    }catch(e){
      console.error('❌ Errore Supabase:', e);
      return;
    }
    wireCampaigns();
    await guardSession(); // redirect se non loggato
  })();
})();
</script>
</body>
</html>
