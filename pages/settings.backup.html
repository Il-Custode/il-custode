<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Il Custode - Impostazioni</title>
  <style>
    :root{
      --legno:#4b3621; --pelle:#d2b48c; --pelle-scura:#c2a178; --inchiostro:#3e2f1c;
      --font-scale:1;  /* controllata da custode.font.size */
      --app-font: system-ui, "Segoe UI", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
    }
    html{ font-size: calc(16px * var(--font-scale,1)); }
    *{ box-sizing:border-box }
    body{
      font-family: var(--app-font);
      margin:0; padding:0; color:var(--inchiostro); text-align:center;
      background:url('../assets/img/sfondo-pergamena-decor.jpg') no-repeat center center fixed; background-size:cover;
    }

    .cornice{
      border:40px solid transparent; -webkit-border-image:url('../assets/img/cornice-legno.png') 40 stretch;
      border-image:url('../assets/img/cornice-legno.png') 40 stretch; min-height:100vh; display:flex; flex-direction:column;
    }
    header{
      position:relative; background-color:rgba(75,54,33,.85); color:#fff8dc; padding:16px 20px;
      border-bottom:5px solid var(--legno); display:flex; align-items:center; justify-content:center; gap:10px; font-size:28px;
    }

    /* Back button iniettato da main.js */
    .back-btn{
      position:absolute; left:20px; top:14px;
      background-color:#a9745b; color:#fff; font-size:16px; border:none; cursor:pointer; padding:8px 12px; border-radius:8px;
    }
    .back-btn:hover{ background:#8b5e47; }

    .container{ width:100%; max-width:960px; margin:0 auto; padding:24px 16px 56px; text-align:left; }
    /* Layout simmetrico: 2 colonne su desktop, 1 su mobile */
    .grid{ display:grid; grid-template-columns:1fr; gap:16px; align-items:start; }
    @media (min-width: 960px){ .grid{ grid-template-columns:1fr 1fr; } }
    .span-2{ grid-column: 1 / -1; }

    .card{ background:rgba(255,248,220,.92); border:3px solid var(--legno); border-radius:12px; padding:16px; box-shadow:0 4px 10px rgba(0,0,0,.12); }
    .card h2{ margin:0 0 8px 0; }
    label{ display:block; font-weight:bold; margin:6px 0 8px; }

    .row{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .row > *{ flex:1 1 0; }

    .card select,
    .card input[type="number"],
    .card .primary-btn{
      width:100%;
      padding:10px;
      border:2px solid var(--legno);
      border-radius:8px;
      font-size:16px;
      background:#fffdf3;
      font-family:inherit;
    }
    .primary-btn{
      background:var(--pelle);
      border:3px solid var(--legno);
      cursor:pointer;
    }
    .primary-btn:hover{ background:var(--pelle-scura); }
    .secondary-btn{
      background:#fffdf3;
      border:2px dashed var(--legno);
      cursor:pointer;
      padding:10px; border-radius:8px; font-size:16px;
    }
    .secondary-btn:hover{ background:#f6eed7; }

    .muted{ font-size:13px; opacity:.85; }
    .little-gap{ height:8px; }
    .big-gap{ height:12px; }

    /* Card compatte per simmetria */
    .card.compact{ padding:12px; }
    .card.compact h2{ margin-bottom:4px; font-size:18px; }
    .compact .row{ gap:8px; }
    .inline-setting{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:6px 0; }
    .inline-setting > .label{ flex:1; font-size:14px; opacity:.9; }
    .inline-setting > input[type="checkbox"]{ flex:0 0 auto; transform:scale(1.15); }
  </style>
</head>
<body>
  <div class="cornice">
    <header>
      <!-- Nessun back hardcoded: lo inietta main.js (installAutoBack) -->
      <span data-i18n="settings.title">Impostazioni</span>
    </header>

    <div class="container">
      <!-- Lingua (full width) -->
      <section class="card span-2">
        <h2 data-i18n="settings.language.title">Lingua</h2>
        <label for="langSel" data-i18n="settings.language.choose">Scegli la tua lingua</label>
        <div class="row">
          <select id="langSel" aria-label="Lingua">
            <option value="it">Italiano</option>
            <option value="en">English</option>
            <option value="de">Deutsch</option>
            <option value="fr">Français</option>
            <option value="es">Español</option>
            <option value="pt-BR">Português (Brasil)</option>
            <option value="ja">日本語</option>
            <option value="zh-Hans">简体中文</option>
            <option value="ar">العربية</option>
            <option value="ru">Русский</option>
            <option value="hi">हिन्दी</option>
            <option value="ko">한국어</option>
            <option value="tr">Türkçe</option>
            <option value="id">Bahasa Indonesia</option>
            <option value="pl">Polski</option>
            <option value="nl">Nederlands</option>
            <option value="cs">Čeština</option>
            <option value="vi">Tiếng Việt</option>
          </select>
          <button id="applyLangBtn" class="primary-btn" data-i18n="settings.language.apply">Applica lingua</button>
        </div>
        <p class="muted" id="statusMsg"></p>
      </section>

      <div class="grid">
        <!-- Colonna sinistra: Tipografia -->
        <section class="card">
          <h2 data-i18n="settings.font.title">Tipografia</h2>
          <label data-i18n="settings.font.size.title">Dimensione carattere</label>
          <div class="row" role="group" aria-label="Dimensione carattere">
            <button class="secondary-btn" data-font-size="S" data-i18n="settings.font.size.s">S</button>
            <button class="secondary-btn" data-font-size="M" data-i18n="settings.font.size.m">M</button>
            <button class="secondary-btn" data-font-size="L" data-i18n="settings.font.size.l">L</button>
          </div>
          <div class="little-gap"></div>
          <label for="fontFamilySel" data-i18n="settings.font.family.title">Carattere</label>
          <select id="fontFamilySel" aria-label="Carattere">
            <option value="system" data-i18n="settings.font.family.system">Predefinito di sistema</option>
            <option value="segoe">Segoe UI</option>
            <option value="arial">Arial</option>
            <option value="inter">Inter (fallback)</option>
            <option value="verdana">Verdana</option>
            <option value="trebuchet">Trebuchet MS</option>
            <option value="tahoma">Tahoma</option>
            <option value="georgia">Georgia</option>
            <option value="times">Times New Roman</option>
            <option value="courier">Courier New</option>
          </select>
          <p class="muted" data-i18n="settings.font.note">Nota: alcuni font potrebbero non essere installati sul tuo sistema; verranno usati fallback sicuri.</p>
        </section>

        <!-- Colonna destra: Connessione -->
        <section class="card">
          <h2 data-i18n="settings.conn.title">Connessione tavolo (Master)</h2>
          <label for="wsPort" data-i18n="settings.conn.port_label">Porta server WebSocket</label>
          <input id="wsPort" type="number" min="1" max="65535" step="1" value="8080"/>
          <div class="little-gap"></div>
          <button id="savePortBtn" class="primary-btn" data-i18n="settings.conn.save">Salva porta</button>
          <p class="muted" id="portSaved"></p>
        </section>

        <!-- Aggiornamenti (compatto) -->
        <section class="card compact">
          <h2 data-i18n="settings.updates.title">Aggiornamenti</h2>
          <div class="inline-setting">
            <div class="label" data-i18n="settings.updates.auto_download">Scarica aggiornamenti automaticamente</div>
            <input type="checkbox" id="autoDownloadChk"/>
          </div>
          <div class="inline-setting">
            <div class="label" data-i18n="settings.updates.install_on_quit">Installa alla chiusura (X)</div>
            <input type="checkbox" id="installOnQuitChk"/>
          </div>
        </section>

        <!-- Avanzate (compatto) -->
        <section class="card compact">
          <h2 data-i18n="settings.advanced.title">Avanzate</h2>
          <div class="row">
            <button id="reloadBtn" class="secondary-btn" data-i18n="settings.advanced.reload">Ricarica finestra</button>
            <button id="resetLayoutBtn" class="secondary-btn" data-i18n="settings.advanced.reset_layout">Reimposta layout</button>
          </div>
        </section>

        <!-- Dati (full width per equilibrio) -->
        <section class="card span-2">
          <h2 data-i18n="settings.data.title">Dati</h2>
          <div class="row">
            <button id="exportBtn" class="secondary-btn" data-i18n="settings.data.export">Esporta dati (JSON)</button>
            <label for="importFile" class="secondary-btn" style="text-align:center; cursor:pointer;" data-i18n="settings.data.import">Importa dati (JSON)</label>
            <input id="importFile" type="file" accept="application/json" style="display:none"/>
          </div>
          <div class="big-gap"></div>
          <div class="row">
            <button id="resetPrefsBtn" class="secondary-btn" data-i18n="settings.data.reset_prefs">Ripristina impostazioni predefinite</button>
            <button id="clearCacheBtn" class="secondary-btn" data-i18n="settings.data.clear_cache">Svuota cache locale</button>
          </div>
          <p class="muted" data-i18n="settings.data.note">Nota: il reset tocca solo le preferenze. Lo svuotamento cache richiede doppia conferma.</p>
        </section>
      </div>
    </div>
  </div>

  <div id="toast" role="status" aria-live="polite"></div>

  <!-- i18n DEVE essere caricato prima -->
  <script defer src="../assets/js/i18n.js"></script>

  <!-- Fallback i18n in TUTTE le lingue dell'elenco -->
  <script>
    const FALLBACK_I18N = {
      'it': {
        'settings.title':'Impostazioni',
        'settings.language.title':'Lingua',
        'settings.language.choose':'Scegli la tua lingua',
        'settings.language.apply':'Applica lingua',
        'settings.language.applied':'Lingua applicata',

        'settings.font.title':'Tipografia',
        'settings.font.size.title':'Dimensione carattere',
        'settings.font.size.s':'S',
        'settings.font.size.m':'M',
        'settings.font.size.l':'L',
        'settings.font.family.title':'Carattere',
        'settings.font.family.system':'Predefinito di sistema',
        'settings.font.note':'Nota: alcuni font potrebbero non essere installati sul tuo sistema; verranno usati fallback sicuri.',

        'settings.data.title':'Dati',
        'settings.data.export':'Esporta dati (JSON)',
        'settings.data.import':'Importa dati (JSON)',
        'settings.data.reset_prefs':'Ripristina impostazioni predefinite',
        'settings.data.clear_cache':'Svuota cache locale',
        'settings.data.confirm_reset':'Ripristinare le impostazioni predefinite?',
        'settings.data.confirm_clear':'Svuotare la cache locale? Questa azione non può essere annullata. Confermi di nuovo?',
        'settings.data.note':'Nota: il reset tocca solo le preferenze. Lo svuotamento cache richiede doppia conferma.',

        'settings.conn.title':'Connessione tavolo (Master)',
        'settings.conn.port_label':'Porta server WebSocket',
        'settings.conn.save':'Salva porta',
        'settings.conn.saved':'Porta salvata',

        'settings.updates.title':'Aggiornamenti',
        'settings.updates.auto_download':'Scarica aggiornamenti automaticamente',
        'settings.updates.install_on_quit':'Installa alla chiusura (X)',

        'settings.advanced.title':'Avanzate',
        'settings.advanced.reload':'Ricarica finestra',
        'settings.advanced.reset_layout':'Reimposta layout',

        'settings.toast.saved':'Salvato',
        'settings.toast.error':'Errore'
      },
      'en': {
        'settings.title':'Settings',
        'settings.language.title':'Language',
        'settings.language.choose':'Choose your language',
        'settings.language.apply':'Apply language',
        'settings.language.applied':'Language applied',

        'settings.font.title':'Typography',
        'settings.font.size.title':'Font size',
        'settings.font.size.s':'S',
        'settings.font.size.m':'M',
        'settings.font.size.l':'L',
        'settings.font.family.title':'Font family',
        'settings.font.family.system':'System default',
        'settings.font.note':'Note: some fonts may not be installed on your system; safe fallbacks will be used.',

        'settings.data.title':'Data',
        'settings.data.export':'Export data (JSON)',
        'settings.data.import':'Import data (JSON)',
        'settings.data.reset_prefs':'Reset preferences to default',
        'settings.data.clear_cache':'Clear local cache',
        'settings.data.confirm_reset':'Reset preferences to default?',
        'settings.data.confirm_clear':'Clear local cache? This can’t be undone. Confirm again?',
        'settings.data.note':'Note: reset touches preferences only. Clearing cache needs double confirm.',

        'settings.conn.title':'Table connection (Master)',
        'settings.conn.port_label':'WebSocket server port',
        'settings.conn.save':'Save port',
        'settings.conn.saved':'Port saved',

        'settings.updates.title':'Updates',
        'settings.updates.auto_download':'Auto-download updates',
        'settings.updates.install_on_quit':'Install on quit (X)',

        'settings.advanced.title':'Advanced',
        'settings.advanced.reload':'Reload window',
        'settings.advanced.reset_layout':'Reset layout',

        'settings.toast.saved':'Saved',
        'settings.toast.error':'Error'
      },
      'de': {
        'settings.title':'Einstellungen',
        'settings.language.title':'Sprache',
        'settings.language.choose':'Wähle deine Sprache',
        'settings.language.apply':'Sprache anwenden',
        'settings.language.applied':'Sprache angewendet',

        'settings.font.title':'Typografie',
        'settings.font.size.title':'Schriftgröße',
        'settings.font.size.s':'S',
        'settings.font.size.m':'M',
        'settings.font.size.l':'L',
        'settings.font.family.title':'Schriftfamilie',
        'settings.font.family.system':'Systemstandard',
        'settings.font.note':'Hinweis: Einige Schriftarten sind evtl. nicht installiert; sichere Fallbacks werden verwendet.',

        'settings.data.title':'Daten',
        'settings.data.export':'Daten exportieren (JSON)',
        'settings.data.import':'Daten importieren (JSON)',
        'settings.data.reset_prefs':'Einstellungen auf Standard zurücksetzen',
        'settings.data.clear_cache':'Lokalen Cache leeren',
        'settings.data.confirm_reset':'Einstellungen auf Standard zurücksetzen?',
        'settings.data.confirm_clear':'Lokalen Cache löschen? Dies kann nicht rückgängig gemacht werden. Nochmals bestätigen?',
        'settings.data.note':'Hinweis: Zurücksetzen betrifft nur die Einstellungen. Cache leeren erfordert doppelte Bestätigung.',

        'settings.conn.title':'Tischverbindung (Master)',
        'settings.conn.port_label':'WebSocket-Server-Port',
        'settings.conn.save':'Port speichern',
        'settings.conn.saved':'Port gespeichert',

        'settings.updates.title':'Updates',
        'settings.updates.auto_download':'Updates automatisch herunterladen',
        'settings.updates.install_on_quit':'Beim Beenden installieren (X)',

        'settings.advanced.title':'Erweitert',
        'settings.advanced.reload':'Fenster neu laden',
        'settings.advanced.reset_layout':'Layout zurücksetzen',

        'settings.toast.saved':'Gespeichert',
        'settings.toast.error':'Fehler'
      },
      'fr': {
        'settings.title':'Paramètres',
        'settings.language.title':'Langue',
        'settings.language.choose':'Choisissez votre langue',
        'settings.language.apply':'Appliquer la langue',
        'settings.language.applied':'Langue appliquée',

        'settings.font.title':'Typographie',
        'settings.font.size.title':'Taille de police',
        'settings.font.size.s':'S',
        'settings.font.size.m':'M',
        'settings.font.size.l':'L',
        'settings.font.family.title':'Famille de polices',
        'settings.font.family.system':'Par défaut du système',
        'settings.font.note':'Remarque : certaines polices peuvent ne pas être installées ; des alternatives sûres seront utilisées.',

        'settings.data.title':'Données',
        'settings.data.export':'Exporter les données (JSON)',
        'settings.data.import':'Importer des données (JSON)',
        'settings.data.reset_prefs':'Réinitialiser les préférences par défaut',
        'settings.data.clear_cache':'Vider le cache local',
        'settings.data.confirm_reset':'Réinitialiser les préférences par défaut ?',
        'settings.data.confirm_clear':'Vider le cache local ? Action irréversible. Confirmer à nouveau ?',
        'settings.data.note':'Remarque : la réinitialisation ne concerne que les préférences. La suppression du cache nécessite une double confirmation.',

        'settings.conn.title':'Connexion à la table (Maître)',
        'settings.conn.port_label':'Port du serveur WebSocket',
        'settings.conn.save':'Enregistrer le port',
        'settings.conn.saved':'Port enregistré',

        'settings.updates.title':'Mises à jour',
        'settings.updates.auto_download':'Télécharger automatiquement les mises à jour',
        'settings.updates.install_on_quit':'Installer à la fermeture (X)',

        'settings.advanced.title':'Avancé',
        'settings.advanced.reload':'Recharger la fenêtre',
        'settings.advanced.reset_layout':'Réinitialiser la mise en page',

        'settings.toast.saved':'Enregistré',
        'settings.toast.error':'Erreur'
      },
      'es': {
        'settings.title':'Configuración',
        'settings.language.title':'Idioma',
        'settings.language.choose':'Elige tu idioma',
        'settings.language.apply':'Aplicar idioma',
        'settings.language.applied':'Idioma aplicado',

        'settings.font.title':'Tipografía',
        'settings.font.size.title':'Tamaño de fuente',
        'settings.font.size.s':'S',
        'settings.font.size.m':'M',
        'settings.font.size.l':'L',
        'settings.font.family.title':'Familia de fuentes',
        'settings.font.family.system':'Predeterminado del sistema',
        'settings.font.note':'Nota: Es posible que algunas fuentes no estén instaladas; se usarán alternativas seguras.',

        'settings.data.title':'Datos',
        'settings.data.export':'Exportar datos (JSON)',
        'settings.data.import':'Importar datos (JSON)',
        'settings.data.reset_prefs':'Restablecer preferencias por defecto',
        'settings.data.clear_cache':'Borrar caché local',
        'settings.data.confirm_reset':'¿Restablecer las preferencias por defecto?',
        'settings.data.confirm_clear':'¿Borrar la caché local? Esta acción no se puede deshacer. ¿Confirmar de nuevo?',
        'settings.data.note':'Nota: el restablecimiento solo afecta a las preferencias. Vaciar la caché requiere doble confirmación.',

        'settings.conn.title':'Conexión de mesa (Maestro)',
        'settings.conn.port_label':'Puerto del servidor WebSocket',
        'settings.conn.save':'Guardar puerto',
        'settings.conn.saved':'Puerto guardado',

        'settings.updates.title':'Actualizaciones',
        'settings.updates.auto_download':'Descargar actualizaciones automáticamente',
        'settings.updates.install_on_quit':'Instalar al salir (X)',

        'settings.advanced.title':'Avanzado',
        'settings.advanced.reload':'Recargar ventana',
        'settings.advanced.reset_layout':'Restablecer diseño',

        'settings.toast.saved':'Guardado',
        'settings.toast.error':'Error'
      },
      'pt-BR': {
        'settings.title':'Configurações',
        'settings.language.title':'Idioma',
        'settings.language.choose':'Escolha seu idioma',
        'settings.language.apply':'Aplicar idioma',
        'settings.language.applied':'Idioma aplicado',

        'settings.font.title':'Tipografia',
        'settings.font.size.title':'Tamanho da fonte',
        'settings.font.size.s':'S',
        'settings.font.size.m':'M',
        'settings.font.size.l':'L',
        'settings.font.family.title':'Família de fontes',
        'settings.font.family.system':'Padrão do sistema',
        'settings.font.note':'Observação: algumas fontes podem não estar instaladas; serão usados fallbacks seguros.',

        'settings.data.title':'Dados',
        'settings.data.export':'Exportar dados (JSON)',
        'settings.data.import':'Importar dados (JSON)',
        'settings.data.reset_prefs':'Restaurar preferências padrão',
        'settings.data.clear_cache':'Limpar cache local',
        'settings.data.confirm_reset':'Restaurar preferências padrão?',
        'settings.data.confirm_clear':'Limpar cache local? Esta ação não pode ser desfeita. Confirmar novamente?',
        'settings.data.note':'Observação: a redefinição afeta apenas as preferências. Limpar o cache requer dupla confirmação.',

        'settings.conn.title':'Conexão da mesa (Mestre)',
        'settings.conn.port_label':'Porta do servidor WebSocket',
        'settings.conn.save':'Salvar porta',
        'settings.conn.saved':'Porta salva',

        'settings.updates.title':'Atualizações',
        'settings.updates.auto_download':'Baixar atualizações automaticamente',
        'settings.updates.install_on_quit':'Instalar ao sair (X)',

        'settings.advanced.title':'Avançado',
        'settings.advanced.reload':'Recarregar janela',
        'settings.advanced.reset_layout':'Redefinir layout',

        'settings.toast.saved':'Salvo',
        'settings.toast.error':'Erro'
      },
      'ja': {
        'settings.title':'設定',
        'settings.language.title':'言語',
        'settings.language.choose':'言語を選択',
        'settings.language.apply':'言語を適用',
        'settings.language.applied':'言語を適用しました',

        'settings.font.title':'タイポグラフィ',
        'settings.font.size.title':'フォントサイズ',
        'settings.font.size.s':'S',
        'settings.font.size.m':'M',
        'settings.font.size.l':'L',
        'settings.font.family.title':'フォントファミリ',
        'settings.font.family.system':'システム既定',
        'settings.font.note':'注：一部のフォントはインストールされていない場合があります。安全な代替が使用されます。',

        'settings.data.title':'データ',
        'settings.data.export':'データを書き出し (JSON)',
        'settings.data.import':'データを読み込み (JSON)',
        'settings.data.reset_prefs':'設定を既定にリセット',
        'settings.data.clear_cache':'ローカルキャッシュをクリア',
        'settings.data.confirm_reset':'設定を既定にリセットしますか？',
        'settings.data.confirm_clear':'ローカルキャッシュをクリアしますか？この操作は元に戻せません。もう一度確認しますか？',
        'settings.data.note':'注：リセットは設定のみに影響します。キャッシュのクリアは二重の確認が必要です。',

        'settings.conn.title':'テーブル接続（マスター）',
        'settings.conn.port_label':'WebSocket サーバーのポート',
        'settings.conn.save':'ポートを保存',
        'settings.conn.saved':'ポートを保存しました',

        'settings.updates.title':'アップデート',
        'settings.updates.auto_download':'アップデートを自動ダウンロード',
        'settings.updates.install_on_quit':'終了時にインストール (X)',

        'settings.advanced.title':'詳細設定',
        'settings.advanced.reload':'ウィンドウを再読み込み',
        'settings.advanced.reset_layout':'レイアウトをリセット',

        'settings.toast.saved':'保存しました',
        'settings.toast.error':'エラー'
      },
      'zh-Hans': {
        'settings.title':'设置',
        'settings.language.title':'语言',
        'settings.language.choose':'选择你的语言',
        'settings.language.apply':'应用语言',
        'settings.language.applied':'已应用语言',

        'settings.font.title':'版式',
        'settings.font.size.title':'字体大小',
        'settings.font.size.s':'S',
        'settings.font.size.m':'M',
        'settings.font.size.l':'L',
        'settings.font.family.title':'字体族',
        'settings.font.family.system':'系统默认',
        'settings.font.note':'注：某些字体可能未安装；将使用安全的后备字体。',

        'settings.data.title':'数据',
        'settings.data.export':'导出数据 (JSON)',
        'settings.data.import':'导入数据 (JSON)',
        'settings.data.reset_prefs':'恢复默认首选项',
        'settings.data.clear_cache':'清除本地缓存',
        'settings.data.confirm_reset':'恢复默认首选项？',
        'settings.data.confirm_clear':'清除本地缓存？此操作无法撤销。请再次确认？',
        'settings.data.note':'注：重置仅影响首选项。清除缓存需要二次确认。',

        'settings.conn.title':'桌面连接（主机）',
        'settings.conn.port_label':'WebSocket 服务器端口',
        'settings.conn.save':'保存端口',
        'settings.conn.saved':'端口已保存',

        'settings.updates.title':'更新',
        'settings.updates.auto_download':'自动下载更新',
        'settings.updates.install_on_quit':'退出时安装 (X)',

        'settings.advanced.title':'高级',
        'settings.advanced.reload':'重新加载窗口',
        'settings.advanced.reset_layout':'重置布局',

        'settings.toast.saved':'已保存',
        'settings.toast.error':'错误'
      },
      'ar': {
        'settings.title':'الإعدادات',
        'settings.language.title':'اللغة',
        'settings.language.choose':'اختر لغتك',
        'settings.language.apply':'تطبيق اللغة',
        'settings.language.applied':'تم تطبيق اللغة',

        'settings.font.title':'الطباعة',
        'settings.font.size.title':'حجم الخط',
        'settings.font.size.s':'S',
        'settings.font.size.m':'M',
        'settings.font.size.l':'L',
        'settings.font.family.title':'عائلة الخط',
        'settings.font.family.system':'الإعداد الافتراضي للنظام',
        'settings.font.note':'ملاحظة: قد لا تكون بعض الخطوط مثبتة؛ سيتم استخدام بدائل آمنة.',

        'settings.data.title':'البيانات',
        'settings.data.export':'تصدير البيانات (JSON)',
        'settings.data.import':'استيراد البيانات (JSON)',
        'settings.data.reset_prefs':'إعادة تعيين التفضيلات إلى الافتراضي',
        'settings.data.clear_cache':'مسح ذاكرة التخزين المحلية',
        'settings.data.confirm_reset':'إعادة تعيين التفضيلات إلى الافتراضي؟',
        'settings.data.confirm_clear':'مسح ذاكرة التخزين المحلية؟ لا يمكن التراجع عن هذا الإجراء. هل تؤكد مرة أخرى؟',
        'settings.data.note':'ملاحظة: تؤثر إعادة التعيين على التفضيلات فقط. يتطلب مسح الذاكرة التخزينية تأكيدًا مزدوجًا.',

        'settings.conn.title':'اتصال الطاولة (الرئيسي)',
        'settings.conn.port_label':'منفذ خادم WebSocket',
        'settings.conn.save':'حفظ المنفذ',
        'settings.conn.saved':'تم حفظ المنفذ',

        'settings.updates.title':'التحديثات',
        'settings.updates.auto_download':'تنزيل التحديثات تلقائيًا',
        'settings.updates.install_on_quit':'التثبيت عند الإغلاق (X)',

        'settings.advanced.title':'متقدم',
        'settings.advanced.reload':'إعادة تحميل النافذة',
        'settings.advanced.reset_layout':'إعادة تعيين التخطيط',

        'settings.toast.saved':'تم الحفظ',
        'settings.toast.error':'خطأ'
      },
      'ru': {
        'settings.title':'Настройки',
        'settings.language.title':'Язык',
        'settings.language.choose':'Выберите язык',
        'settings.language.apply':'Применить язык',
        'settings.language.applied':'Язык применён',

        'settings.font.title':'Типографика',
        'settings.font.size.title':'Размер шрифта',
        'settings.font.size.s':'S',
        'settings.font.size.m':'M',
        'settings.font.size.l':'L',
        'settings.font.family.title':'Семейство шрифтов',
        'settings.font.family.system':'Системное по умолчанию',
        'settings.font.note':'Примечание: некоторые шрифты могут быть не установлены; будут использованы безопасные замены.',

        'settings.data.title':'Данные',
        'settings.data.export':'Экспорт данных (JSON)',
        'settings.data.import':'Импорт данных (JSON)',
        'settings.data.reset_prefs':'Сбросить настройки по умолчанию',
        'settings.data.clear_cache':'Очистить локальный кэш',
        'settings.data.confirm_reset':'Сбросить настройки по умолчанию?',
        'settings.data.confirm_clear':'Очистить локальный кэш? Это действие нельзя отменить. Подтвердить ещё раз?',
        'settings.data.note':'Примечание: сброс касается только предпочтений. Очистка кэша требует двойного подтверждения.',

        'settings.conn.title':'Подключение стола (Мастер)',
        'settings.conn.port_label':'Порт сервера WebSocket',
        'settings.conn.save':'Сохранить порт',
        'settings.conn.saved':'Порт сохранён',

        'settings.updates.title':'Обновления',
        'settings.updates.auto_download':'Автоматически загружать обновления',
        'settings.updates.install_on_quit':'Устанавливать при выходе (X)',

        'settings.advanced.title':'Дополнительно',
        'settings.advanced.reload':'Перезагрузить окно',
        'settings.advanced.reset_layout':'Сбросить раскладку',

        'settings.toast.saved':'Сохранено',
        'settings.toast.error':'Ошибка'
      },
      'hi': {
        'settings.title':'सेटिंग्स',
        'settings.language.title':'भाषा',
        'settings.language.choose':'अपनी भाषा चुनें',
        'settings.language.apply':'भाषा लागू करें',
        'settings.language.applied':'भाषा लागू की गई',

        'settings.font.title':'टाइपोग्राफी',
        'settings.font.size.title':'फ़ॉन्ट आकार',
        'settings.font.size.s':'S',
        'settings.font.size.m':'M',
        'settings.font.size.l':'L',
        'settings.font.family.title':'फ़ॉन्ट परिवार',
        'settings.font.family.system':'सिस्टम डिफ़ॉल्ट',
        'settings.font.note':'नोट: कुछ फ़ॉन्ट आपके सिस्टम में इंस्टॉल नहीं हो सकते; सुरक्षित फॉलबैक का उपयोग होगा।',

        'settings.data.title':'डेटा',
        'settings.data.export':'डेटा निर्यात करें (JSON)',
        'settings.data.import':'डेटा आयात करें (JSON)',
        'settings.data.reset_prefs':'पसंदें डिफ़ॉल्ट पर रीसेट करें',
        'settings.data.clear_cache':'लोकल कैश साफ़ करें',
        'settings.data.confirm_reset':'पसंदें डिफ़ॉल्ट पर रीसेट करें?',
        'settings.data.confirm_clear':'लोकल कैश साफ़ करें? यह कार्रवाई वापस नहीं ली जा सकती। फिर से पुष्टि करें?',
        'settings.data.note':'नोट: रीसेट केवल पसंदों पर लागू होता है। कैश साफ़ करने के लिए दो बार पुष्टि ज़रूरी है।',

        'settings.conn.title':'टेबल कनेक्शन (मास्टर)',
        'settings.conn.port_label':'WebSocket सर्वर पोर्ट',
        'settings.conn.save':'पोर्ट सहेजें',
        'settings.conn.saved':'पोर्ट सहेजा गया',

        'settings.updates.title':'अपडेट्स',
        'settings.updates.auto_download':'अपडेट अपने-आप डाउनलोड करें',
        'settings.updates.install_on_quit':'बंद करते समय इंस्टॉल करें (X)',

        'settings.advanced.title':'उन्नत',
        'settings.advanced.reload':'विंडो रीलोड करें',
        'settings.advanced.reset_layout':'लेआउट रीसेट करें',

        'settings.toast.saved':'सहेजा गया',
        'settings.toast.error':'त्रुटि'
      },
      'ko': {
        'settings.title':'설정',
        'settings.language.title':'언어',
        'settings.language.choose':'언어를 선택하세요',
        'settings.language.apply':'언어 적용',
        'settings.language.applied':'언어가 적용되었습니다',

        'settings.font.title':'타이포그래피',
        'settings.font.size.title':'글꼴 크기',
        'settings.font.size.s':'S',
        'settings.font.size.m':'M',
        'settings.font.size.l':'L',
        'settings.font.family.title':'글꼴 패밀리',
        'settings.font.family.system':'시스템 기본값',
        'settings.font.note':'참고: 일부 글꼴이 설치되어 있지 않을 수 있으며, 안전한 대체 글꼴이 사용됩니다.',

        'settings.data.title':'데이터',
        'settings.data.export':'데이터 내보내기 (JSON)',
        'settings.data.import':'데이터 가져오기 (JSON)',
        'settings.data.reset_prefs':'기본 설정으로 재설정',
        'settings.data.clear_cache':'로컬 캐시 지우기',
        'settings.data.confirm_reset':'기본 설정으로 재설정하시겠습니까?',
        'settings.data.confirm_clear':'로컬 캐시를 지우시겠습니까? 이 작업은 되돌릴 수 없습니다. 다시 확인하시겠습니까?',
        'settings.data.note':'참고: 재설정은 환경설정에만 영향을 줍니다. 캐시 지우기는 이중 확인이 필요합니다.',

        'settings.conn.title':'테이블 연결(마스터)',
        'settings.conn.port_label':'WebSocket 서버 포트',
        'settings.conn.save':'포트 저장',
        'settings.conn.saved':'포트가 저장되었습니다',

        'settings.updates.title':'업데이트',
        'settings.updates.auto_download':'업데이트 자동 다운로드',
        'settings.updates.install_on_quit':'종료 시 설치 (X)',

        'settings.advanced.title':'고급',
        'settings.advanced.reload':'창 새로고침',
        'settings.advanced.reset_layout':'레이아웃 재설정',

        'settings.toast.saved':'저장됨',
        'settings.toast.error':'오류'
      },
      'tr': {
        'settings.title':'Ayarlar',
        'settings.language.title':'Dil',
        'settings.language.choose':'Dilini seç',
        'settings.language.apply':'Dili uygula',
        'settings.language.applied':'Dil uygulandı',

        'settings.font.title':'Tipografi',
        'settings.font.size.title':'Yazı tipi boyutu',
        'settings.font.size.s':'S',
        'settings.font.size.m':'M',
        'settings.font.size.l':'L',
        'settings.font.family.title':'Yazı tipi ailesi',
        'settings.font.family.system':'Sistem varsayılanı',
        'settings.font.note':'Not: Bazı yazı tipleri yüklü olmayabilir; güvenli yedekler kullanılacaktır.',

        'settings.data.title':'Veriler',
        'settings.data.export':'Verileri dışa aktar (JSON)',
        'settings.data.import':'Verileri içe aktar (JSON)',
        'settings.data.reset_prefs':'Tercihleri varsayılana sıfırla',
        'settings.data.clear_cache':'Yerel önbelleği temizle',
        'settings.data.confirm_reset':'Tercihler varsayılana sıfırlansın mı?',
        'settings.data.confirm_clear':'Yerel önbellek temizlensin mi? Bu işlem geri alınamaz. Yeniden onaylıyor musunuz?',
        'settings.data.note':'Not: Sıfırlama yalnızca tercihleri etkiler. Önbelleği temizlemek çift onay gerektirir.',

        'settings.conn.title':'Masa bağlantısı (Master)',
        'settings.conn.port_label':'WebSocket sunucu bağlantı noktası',
        'settings.conn.save':'Bağlantı noktasını kaydet',
        'settings.conn.saved':'Bağlantı noktası kaydedildi',

        'settings.updates.title':'Güncellemeler',
        'settings.updates.auto_download':'Güncellemeleri otomatik indir',
        'settings.updates.install_on_quit':'Kapanışta yükle (X)',

        'settings.advanced.title':'Gelişmiş',
        'settings.advanced.reload':'Pencereyi yeniden yükle',
        'settings.advanced.reset_layout':'Düzeni sıfırla',

        'settings.toast.saved':'Kaydedildi',
        'settings.toast.error':'Hata'
      },
      'id': {
        'settings.title':'Pengaturan',
        'settings.language.title':'Bahasa',
        'settings.language.choose':'Pilih bahasamu',
        'settings.language.apply':'Terapkan bahasa',
        'settings.language.applied':'Bahasa diterapkan',

        'settings.font.title':'Tipografi',
        'settings.font.size.title':'Ukuran font',
        'settings.font.size.s':'S',
        'settings.font.size.m':'M',
        'settings.font.size.l':'L',
        'settings.font.family.title':'Keluarga font',
        'settings.font.family.system':'Bawaan sistem',
        'settings.font.note':'Catatan: Beberapa font mungkin tidak terpasang; fallback aman akan digunakan.',

        'settings.data.title':'Data',
        'settings.data.export':'Ekspor data (JSON)',
        'settings.data.import':'Impor data (JSON)',
        'settings.data.reset_prefs':'Setel ulang preferensi ke default',
        'settings.data.clear_cache':'Hapus cache lokal',
        'settings.data.confirm_reset':'Setel ulang preferensi ke default?',
        'settings.data.confirm_clear':'Hapus cache lokal? Tindakan ini tidak dapat dibatalkan. Konfirmasi lagi?',
        'settings.data.note':'Catatan: penyetelan ulang hanya memengaruhi preferensi. Menghapus cache memerlukan konfirmasi ganda.',

        'settings.conn.title':'Koneksi meja (Master)',
        'settings.conn.port_label':'Port server WebSocket',
        'settings.conn.save':'Simpan port',
        'settings.conn.saved':'Port disimpan',

        'settings.updates.title':'Pembaruan',
        'settings.updates.auto_download':'Unduh pembaruan otomatis',
        'settings.updates.install_on_quit':'Instal saat keluar (X)',

        'settings.advanced.title':'Lanjutan',
        'settings.advanced.reload':'Muat ulang jendela',
        'settings.advanced.reset_layout':'Setel ulang tata letak',

        'settings.toast.saved':'Tersimpan',
        'settings.toast.error':'Kesalahan'
      },
      'pl': {
        'settings.title':'Ustawienia',
        'settings.language.title':'Język',
        'settings.language.choose':'Wybierz swój język',
        'settings.language.apply':'Zastosuj język',
        'settings.language.applied':'Język zastosowano',

        'settings.font.title':'Typografia',
        'settings.font.size.title':'Rozmiar czcionki',
        'settings.font.size.s':'S',
        'settings.font.size.m':'M',
        'settings.font.size.l':'L',
        'settings.font.family.title':'Krój pisma',
        'settings.font.family.system':'Domyślny systemowy',
        'settings.font.note':'Uwaga: niektóre czcionki mogą nie być zainstalowane; zostaną użyte bezpieczne zamienniki.',

        'settings.data.title':'Dane',
        'settings.data.export':'Eksportuj dane (JSON)',
        'settings.data.import':'Importuj dane (JSON)',
        'settings.data.reset_prefs':'Przywróć domyślne preferencje',
        'settings.data.clear_cache':'Wyczyść pamięć podręczną lokalną',
        'settings.data.confirm_reset':'Przywrócić ustawienia domyślne?',
        'settings.data.confirm_clear':'Wyczyścić lokalną pamięć podręczną? Tej operacji nie można cofnąć. Potwierdź ponownie.',
        'settings.data.note':'Uwaga: reset dotyczy tylko preferencji. Czyszczenie pamięci podręcznej wymaga podwójnego potwierdzenia.',

        'settings.conn.title':'Połączenie stołu (Master)',
        'settings.conn.port_label':'Port serwera WebSocket',
        'settings.conn.save':'Zapisz port',
        'settings.conn.saved':'Port zapisany',

        'settings.updates.title':'Aktualizacje',
        'settings.updates.auto_download':'Automatycznie pobieraj aktualizacje',
        'settings.updates.install_on_quit':'Instaluj przy zamknięciu (X)',

        'settings.advanced.title':'Zaawansowane',
        'settings.advanced.reload':'Przeładuj okno',
        'settings.advanced.reset_layout':'Resetuj układ',

        'settings.toast.saved':'Zapisano',
        'settings.toast.error':'Błąd'
      },
      'nl': {
        'settings.title':'Instellingen',
        'settings.language.title':'Taal',
        'settings.language.choose':'Kies je taal',
        'settings.language.apply':'Taal toepassen',
        'settings.language.applied':'Taal toegepast',

        'settings.font.title':'Typografie',
        'settings.font.size.title':'Lettergrootte',
        'settings.font.size.s':'S',
        'settings.font.size.m':'M',
        'settings.font.size.l':'L',
        'settings.font.family.title':'Lettertypefamilie',
        'settings.font.family.system':'Systeemstandaard',
        'settings.font.note':'Opmerking: sommige lettertypen zijn mogelijk niet geïnstalleerd; er worden veilige fallbacks gebruikt.',

        'settings.data.title':'Gegevens',
        'settings.data.export':'Gegevens exporteren (JSON)',
        'settings.data.import':'Gegevens importeren (JSON)',
        'settings.data.reset_prefs':'Voorkeuren terugzetten naar standaard',
        'settings.data.clear_cache':'Lokale cache legen',
        'settings.data.confirm_reset':'Voorkeuren terugzetten naar standaard?',
        'settings.data.confirm_clear':'Lokale cache legen? Deze actie kan niet ongedaan worden gemaakt. Nogmaals bevestigen?',
        'settings.data.note':'Opmerking: reset beïnvloedt alleen voorkeuren. Cache legen vereist dubbele bevestiging.',

        'settings.conn.title':'Tafelverbinding (Master)',
        'settings.conn.port_label':'WebSocket-serverpoort',
        'settings.conn.save':'Poort opslaan',
        'settings.conn.saved':'Poort opgeslagen',

        'settings.updates.title':'Updates',
        'settings.updates.auto_download':'Updates automatisch downloaden',
        'settings.updates.install_on_quit':'Installeren bij afsluiten (X)',

        'settings.advanced.title':'Geavanceerd',
        'settings.advanced.reload':'Venster herladen',
        'settings.advanced.reset_layout':'Indeling resetten',

        'settings.toast.saved':'Opgeslagen',
        'settings.toast.error':'Fout'
      },
      'cs': {
        'settings.title':'Nastavení',
        'settings.language.title':'Jazyk',
        'settings.language.choose':'Vyberte svůj jazyk',
        'settings.language.apply':'Použít jazyk',
        'settings.language.applied':'Jazyk použit',

        'settings.font.title':'Typografie',
        'settings.font.size.title':'Velikost písma',
        'settings.font.size.s':'S',
        'settings.font.size.m':'M',
        'settings.font.size.l':'L',
        'settings.font.family.title':'Rodina písem',
        'settings.font.family.system':'Výchozí systému',
        'settings.font.note':'Poznámka: Některá písma nemusí být nainstalována; použijí se bezpečné náhrady.',

        'settings.data.title':'Data',
        'settings.data.export':'Exportovat data (JSON)',
        'settings.data.import':'Importovat data (JSON)',
        'settings.data.reset_prefs':'Obnovit výchozí předvolby',
        'settings.data.clear_cache':'Vymazat místní mezipaměť',
        'settings.data.confirm_reset':'Obnovit výchozí předvolby?',
        'settings.data.confirm_clear':'Vymazat místní mezipaměť? Tuto akci nelze vrátit zpět. Potvrďte znovu.',
        'settings.data.note':'Poznámka: reset ovlivní pouze předvolby. Vymazání mezipaměti vyžaduje dvojí potvrzení.',

        'settings.conn.title':'Připojení stolu (Master)',
        'settings.conn.port_label':'Port serveru WebSocket',
        'settings.conn.save':'Uložit port',
        'settings.conn.saved':'Port uložen',

        'settings.updates.title':'Aktualizace',
        'settings.updates.auto_download':'Automatické stahování aktualizací',
        'settings.updates.install_on_quit':'Instalovat při ukončení (X)',

        'settings.advanced.title':'Pokročilé',
        'settings.advanced.reload':'Znovu načíst okno',
        'settings.advanced.reset_layout':'Obnovit rozvržení',

        'settings.toast.saved':'Uloženo',
        'settings.toast.error':'Chyba'
      },
      'vi': {
        'settings.title':'Cài đặt',
        'settings.language.title':'Ngôn ngữ',
        'settings.language.choose':'Chọn ngôn ngữ của bạn',
        'settings.language.apply':'Áp dụng ngôn ngữ',
        'settings.language.applied':'Đã áp dụng ngôn ngữ',

        'settings.font.title':'Kiểu chữ',
        'settings.font.size.title':'Cỡ chữ',
        'settings.font.size.s':'S',
        'settings.font.size.m':'M',
        'settings.font.size.l':'L',
        'settings.font.family.title':'Họ phông chữ',
        'settings.font.family.system':'Mặc định hệ thống',
        'settings.font.note':'Lưu ý: Một số phông có thể chưa được cài đặt; sẽ dùng phông dự phòng an toàn.',

        'settings.data.title':'Dữ liệu',
        'settings.data.export':'Xuất dữ liệu (JSON)',
        'settings.data.import':'Nhập dữ liệu (JSON)',
        'settings.data.reset_prefs':'Đặt lại tùy chọn về mặc định',
        'settings.data.clear_cache':'Xóa bộ nhớ đệm cục bộ',
        'settings.data.confirm_reset':'Đặt lại tùy chọn về mặc định?',
        'settings.data.confirm_clear':'Xóa bộ nhớ đệm cục bộ? Hành động này không thể hoàn tác. Xác nhận lại?',
        'settings.data.note':'Lưu ý: đặt lại chỉ ảnh hưởng đến tùy chọn. Xóa bộ nhớ đệm cần xác nhận hai lần.',

        'settings.conn.title':'Kết nối bàn (Master)',
        'settings.conn.port_label':'Cổng máy chủ WebSocket',
        'settings.conn.save':'Lưu cổng',
        'settings.conn.saved':'Đã lưu cổng',

        'settings.updates.title':'Cập nhật',
        'settings.updates.auto_download':'Tự động tải bản cập nhật',
        'settings.updates.install_on_quit':'Cài đặt khi thoát (X)',

        'settings.advanced.title':'Nâng cao',
        'settings.advanced.reload':'Tải lại cửa sổ',
        'settings.advanced.reset_layout':'Đặt lại bố cục',

        'settings.toast.saved':'Đã lưu',
        'settings.toast.error':'Lỗi'
      }
    };

    /* === util i18n locale-only === */
    function currentLang(){
      return localStorage.getItem('custode.lang') || 'it';
    }
    function dictFor(lang){
      return FALLBACK_I18N[lang] || FALLBACK_I18N['en'];
    }
    function translate(root){
      const lang = currentLang();
      const dict = dictFor(lang);
      const scope = root || document;
      scope.querySelectorAll('[data-i18n]').forEach(el=>{
        const key = el.getAttribute('data-i18n');
        if (dict[key]) el.textContent = dict[key];
      });
      scope.querySelectorAll('[data-i18n-placeholder]').forEach(el=>{
        const key = el.getAttribute('data-i18n-placeholder');
        if (dict[key]) el.setAttribute('placeholder', dict[key]);
      });
      try {
        document.title = `Il Custode — ${dict['settings.title'] || 'Impostazioni'}`;
        document.documentElement.setAttribute('lang', lang);
        document.documentElement.setAttribute('dir', (lang==='ar') ? 'rtl' : 'ltr');
      } catch {}
    }
    function t(key){
      const d = dictFor(currentLang());
      return d[key] || key;
    }

    /* ===================== PERSISTENZA ===================== */
    const PREF_KEYS = {
      lang: 'custode.lang',
      fontSize: 'custode.font.size',       // 'S' | 'M' | 'L'
      fontFamily: 'custode.font.family',   // 'system' | 'segoe' | ...
      wsPort: 'custode.ws.port',
      autoDownload: 'custode.updates.autoDownload',
      installOnQuit: 'custode.updates.installOnQuit'
    };

    const DEFAULTS = {
      [PREF_KEYS.lang]: 'it',
      [PREF_KEYS.fontSize]: 'M',
      [PREF_KEYS.fontFamily]: 'system',
      [PREF_KEYS.wsPort]: '8080',
      [PREF_KEYS.autoDownload]: '1',
      [PREF_KEYS.installOnQuit]: '0'
    };

    function getPref(key){ const v=localStorage.getItem(key); return (v===null||v===undefined)?DEFAULTS[key]:v; }
    function setPref(key, value){
      localStorage.setItem(key, value);
      document.dispatchEvent(new CustomEvent('settings:change',{ detail:{ key, value } }));
      showToast(t('settings.toast.saved'));
    }

    /* ===================== RUNTIME APPLY ===================== */
    function applyFont(size){
      // S=0.90, M=1.00, L=1.15
      const scale = size === 'S' ? 0.90 : (size === 'L' ? 1.15 : 1.0);
      document.documentElement.style.setProperty('--font-scale', String(scale));
    }

    function applyFontFamily(fam){
      const stacks = {
        system: 'system-ui, "Segoe UI", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"',
        segoe: '"Segoe UI", system-ui, Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"',
        arial: 'Arial, Helvetica, system-ui, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"',
        inter: '"Inter", system-ui, "Segoe UI", Arial, "Noto Sans"',
        verdana: 'Verdana, Geneva, system-ui, Arial, "Noto Sans"',
        trebuchet: '"Trebuchet MS", Tahoma, system-ui, Arial, "Noto Sans"',
        tahoma: 'Tahoma, "Segoe UI", system-ui, Arial, "Noto Sans"',
        georgia: 'Georgia, "Times New Roman", Times, serif',
        times: '"Times New Roman", Times, Georgia, serif',
        courier: '"Courier New", Courier, monospace'
      };
      const stack = stacks[fam] || stacks.system;
      document.documentElement.style.setProperty('--app-font', stack);
    }

    function showToast(msg){
      const tEl = document.getElementById('toast');
      if (!tEl) return;
      tEl.textContent = msg || '';
      tEl.classList.add('show');
      clearTimeout(showToast._timer);
      showToast._timer = setTimeout(()=> tEl.classList.remove('show'), 1100);
    }

    /* ===================== LINGUA ===================== */
    async function applyLang(){
      const sel = document.getElementById('langSel');
      const status = document.getElementById('statusMsg');
      const lang = sel.value;
      localStorage.setItem(PREF_KEYS.lang, lang);
      status.textContent = '...';
      try{
        // allinea eventuale libreria globale (senza invocare la sua apply)
        if (window.i18n?.setLang) await window.i18n.setLang(lang);
        translate(document);
        status.textContent = t('settings.language.applied');
        setTimeout(()=> status.textContent = '', 900);
        document.dispatchEvent(new CustomEvent('settings:change',{ detail:{ key: PREF_KEYS.lang, value: lang } }));
      } catch(e){
        translate(document);
      }
    }

    /* ===================== EXPORT / IMPORT / RESET / CLEAR ===================== */
    function exportData(){
      const includePrefixes = ['custode.', 'campaign.', 'ilcustode.'];
      const dump = { localStorage:{}, sessionStorage:{} };
      for (let i=0;i<localStorage.length;i++){
        const k = localStorage.key(i);
        if (includePrefixes.some(p=>k.startsWith(p))) dump.localStorage[k]=localStorage.getItem(k);
      }
      for (let i=0;i<sessionStorage.length;i++){
        const k = sessionStorage.key(i);
        if (includePrefixes.some(p=>k.startsWith(p))) dump.sessionStorage[k]=sessionStorage.getItem(k);
      }
      const blob = new Blob([JSON.stringify(dump,null,2)],{type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `custode-export-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
      showToast(t('settings.toast.saved'));
    }

    function importData(file){
      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const obj = JSON.parse(reader.result);
          if (obj.localStorage){
            Object.keys(obj.localStorage).forEach(k=>{
              localStorage.setItem(k, obj.localStorage[k]);
            });
          }
          if (obj.sessionStorage){
            Object.keys(obj.sessionStorage).forEach(k=>{
              sessionStorage.setItem(k, obj.sessionStorage[k]);
            });
          }
          showToast(t('settings.toast.saved'));
          location.reload();
        } catch(e){
          showToast(t('settings.toast.error'));
        }
      };
      reader.readAsText(file);
    }

    function resetPreferencesToDefault(){
      if (!confirm(t('settings.data.confirm_reset'))) return;
      Object.keys(DEFAULTS).forEach(k=> localStorage.setItem(k, DEFAULTS[k]));
      showToast(t('settings.toast.saved'));
      location.reload();
    }

    function clearLocalCache(){
      const msg = t('settings.data.confirm_clear');
      if (!confirm(msg)) return;
      if (!confirm(msg)) return; // doppia conferma
      const keepKeys = Object.keys(DEFAULTS);
      const snapshot = {};
      keepKeys.forEach(k=> snapshot[k] = localStorage.getItem(k) ?? DEFAULTS[k]);
      localStorage.clear();
      Object.keys(snapshot).forEach(k=> localStorage.setItem(k, snapshot[k]));
      sessionStorage.clear();
      showToast(t('settings.toast.saved'));
      location.reload();
    }

    /* ===================== INIT ===================== */
    (function init(){
      const start = ()=>{
        // Traduci subito in base alla lingua salvata
        translate(document);

        // Stato iniziale
        const lang = getPref(PREF_KEYS.lang);
        const fontSize = getPref(PREF_KEYS.fontSize);
        const fontFamily = getPref(PREF_KEYS.fontFamily);
        const wsPort = getPref(PREF_KEYS.wsPort);
        const autoDownload = getPref(PREF_KEYS.autoDownload);
        const installOnQuit = getPref(PREF_KEYS.installOnQuit);

        // Applica runtime
        applyFont(fontSize);
        applyFontFamily(fontFamily);

        // UI: lingua
        const sel = document.getElementById('langSel');
        sel.value = lang;
        document.getElementById('applyLangBtn').addEventListener('click', applyLang);
        document.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && document.activeElement.tagName !== 'INPUT') applyLang(); });

        // UI: font size
        document.querySelectorAll('[data-font-size]').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const fs = btn.getAttribute('data-font-size'); // S|M|L
            setPref(PREF_KEYS.fontSize, fs);
            applyFont(fs);
          });
        });

        // UI: font family
        const fontSel = document.getElementById('fontFamilySel');
        fontSel.value = fontFamily;
        fontSel.addEventListener('change', ()=>{
          const fam = fontSel.value;
          setPref(PREF_KEYS.fontFamily, fam);
          applyFontFamily(fam);
        });

        // UI: Connessione
        const portInput = document.getElementById('wsPort');
        const portSaved = document.getElementById('portSaved');
        portInput.value = String(wsPort || '8080');
        document.getElementById('savePortBtn').addEventListener('click', ()=>{
          let p = parseInt(portInput.value,10);
          if (!Number.isFinite(p) || p<1 || p>65535) { showToast(t('settings.toast.error')); return; }
          setPref(PREF_KEYS.wsPort, String(p));
          portSaved.textContent = t('settings.conn.saved');
          setTimeout(()=> portSaved.textContent='', 900);
        });

        // UI: Aggiornamenti
        const autoChk = document.getElementById('autoDownloadChk');
        const quitChk = document.getElementById('installOnQuitChk');
        autoChk.checked = (autoDownload === '1');
        quitChk.checked = (installOnQuit === '1');
        autoChk.addEventListener('change', ()=> setPref(PREF_KEYS.autoDownload, autoChk.checked ? '1':'0'));
        quitChk.addEventListener('change', ()=> setPref(PREF_KEYS.installOnQuit, quitChk.checked ? '1':'0'));

        // UI: Dati
        document.getElementById('exportBtn').addEventListener('click', exportData);
        document.getElementById('importFile').addEventListener('change', (e)=>{
          const f = e.target.files && e.target.files[0];
          if (f) importData(f);
          e.target.value = '';
        });
        document.getElementById('resetPrefsBtn').addEventListener('click', resetPreferencesToDefault);
        document.getElementById('clearCacheBtn').addEventListener('click', clearLocalCache);

        // UI: Avanzate
        document.getElementById('reloadBtn').addEventListener('click', ()=> location.reload());
        document.getElementById('resetLayoutBtn').addEventListener('click', ()=>{
          Object.keys(localStorage).forEach(k=>{
            if (k.startsWith('custode.layout.')) localStorage.removeItem(k);
          });
          showToast(t('settings.toast.saved'));
          document.dispatchEvent(new CustomEvent('settings:change',{ detail:{ key:'custode.layout.reset', value:Date.now() } }));
        });

        // Se la libreria globale i18n emette un evento, riapplica il nostro fallback
        document.addEventListener('i18n:change', ()=> translate(document));
      };

      if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', start);
      else start();
    })();
  </script>
</body>
</html>
