<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Il Custode — Home</title>

  <!-- Collega lo stile globale valido per tutte le pagine in root -->
  <link rel="stylesheet" href="assets/style.css">

  <style>
    :root{ --legno:#4b3621; --pelle:#d2b48c; --pelle-scura:#c2a178; --inchiostro:#3e2f1c; --pergamena:#fff3d4; }
    *{ box-sizing:border-box }
    html, body { scroll-behavior:auto; } /* evita smooth scroll involontario */

    /* Manteniamo il layout specifico di questa pagina.
       Sfondo/cornice sono già nel CSS globale, ma lasciamo questi come rinforzo coerente. */
    body{
      font-family:'Papyrus', fantasy; margin:0; padding:0; color:var(--inchiostro);
      background:
        radial-gradient(80% 60% at 50% 40%, rgba(0,0,0,.06), transparent 70%),
        var(--pergamena)
        url('assets/sfondo-pergamena-decor.svg') no-repeat center center fixed;
      background-size:cover; text-align:center;
    }
    .cornice{
      border:40px solid transparent;
      -webkit-border-image:url('assets/cornice-legno.svg') 40 stretch;
      border-image:url('assets/cornice-legno.svg') 40 stretch;
      min-height:100vh; display:flex; flex-direction:column;
      background: linear-gradient(180deg, rgba(255,243,212,.30), rgba(255,243,212,.15));
    }
    header{
      position:relative; background-color:rgba(75,54,33,.85); color:#fff8dc; padding:16px 20px;
      border-bottom:5px solid var(--legno); display:flex; align-items:center; justify-content:center; gap:10px; font-size:28px;
    }
    .container{ width:100%; max-width:880px; margin:0 auto; padding:24px 16px 40px; text-align:left; }

    .hero{ display:grid; grid-template-columns:1fr; gap:18px; align-items:center; margin-top:18px; }
    @media(min-width:900px){ .hero{ grid-template-columns: 1fr 1.2fr; } }
    .mago{ display:flex; align-items:center; justify-content:center; padding:10px; }
    .mago img{
      width:min(380px, 70vw); max-width:100%; border:6px solid var(--legno); border-radius:16px; background:#fff9;
      box-shadow:0 8px 22px rgba(0,0,0,.25); opacity:0; transform: translateY(8px) scale(0.98);
    }
    .mago img.img-in{ animation: fadeInImg 1.2s ease-out forwards; }
    @keyframes fadeInImg{ to{ opacity:1; transform:none; } }

    .fumetto{
      position:relative; overflow:visible; background: rgba(255,248,220,.95);
      border:4px solid var(--legno); border-radius:16px; padding:22px; box-shadow:0 8px 22px rgba(0,0,0,.2);
      transform-origin: top center; transform: scaleY(0); opacity:0;
    }
    .fumetto.fumetto-in{ animation: unroll .9s ease-out forwards; }
    @keyframes unroll{ 0%{ transform:scaleY(0); opacity:0; } 100%{ transform:scaleY(1); opacity:1; } }
    .fumetto .titolo{ font-size:26px; margin:0 0 6px; }
    .fumetto .testo{ font-size:18px; line-height:1.5; margin:10px 0 0; }
    .fumetto::after{
      content:""; position:absolute; left:-18px; top:48%; transform: translateY(-50%);
      border-top:14px solid transparent; border-bottom:14px solid transparent; border-right:18px solid rgba(255,248,220,.95);
      filter: drop-shadow(-2px 2px 0 rgba(0,0,0,.15));
    }
    .fumetto::before{
      content:""; position:absolute; left:-22px; top:48%; transform: translateY(-50%);
      border-top:16px solid transparent; border-bottom:16px solid transparent; border-right:22px solid var(--legno);
    }
    @media(max-width:899px){
      .fumetto::after{
        left:50%; top:-18px; transform: translateX(-50%);
        border-left:14px solid transparent; border-right:14px solid transparent; border-bottom:18px solid rgba(255,248,220,.95); border-top:none;
        filter: drop-shadow(0 -2px 0 rgba(0,0,0,.15));
      }
      .fumetto::before{
        left:50%; top:-22px; transform: translateX(-50%);
        border-left:16px solid transparent; border-right:16px solid transparent; border-bottom:22px solid var(--legno); border-top:none;
      }
    }

    .card{ background:rgba(255,248,220,.92); border:3px solid var(--legno); border-radius:12px; padding:16px; margin:18px 0; box-shadow:0 4px 10px rgba(0,0,0,.12); }

    .row{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    input[type="email"], input[type="password"]{
      flex:1 1 260px; padding:10px; border:2px solid var(--legno); border-radius:8px; font-size:16px; font-family:'Papyrus', fantasy; background:#fffdf3;
    }
    .btn{
      background:var(--pelle); border:3px solid var(--legno); padding:8px 14px;
      border-radius:10px; font-family:'Papyrus', fantasy; cursor:pointer; font-size:16px;
      line-height:1;
    }
    .btn:hover{ background:var(--pelle-scura); }
    label.chk{ display:flex; align-items:center; gap:8px; user-select:none; }
    label.chk input{ width:18px; height:18px; }
    .muted{ opacity:.85; font-size:14px; }
  </style>

  <!-- Evita ripristino automatico dello scroll da parte del browser -->
  <script>try { if ('scrollRestoration' in history) history.scrollRestoration = 'manual'; } catch {}</script>

  <!-- i18n e Config Supabase (env) PRIMA del singleton -->
  <script defer src="assets/js/i18n.js"></script>
  <script defer src="assets/js/env.supabase.js"></script>
  <script defer src="assets/js/supabase-singleton.js"></script>
</head>
<body>
<div class="cornice">
  <header>
    <span data-i18n="home.header">Il Custode — Home</span>
  </header>

  <div class="container">
    <section class="hero" aria-label="Presentazione">
      <div class="mago">
        <img id="imgMago" src="assets/img/mago.png" alt="Il Custode"/>
      </div>
      <div id="fumetto" class="fumetto" role="complementary" aria-live="polite">
        <h2 class="titolo" data-i18n="home.wizard_title">Il Custode ti osserva</h2>
        <p id="frase" class="testo"></p>
      </div>
    </section>

    <!-- SOLO LOGIN (pagina 2) -->
    <section id="loginPanel" class="card" aria-label="Login" style="display:none">
      <h2 data-i18n="home.login.title">Accedi</h2>

      <form id="loginForm" autocomplete="on">
        <div class="row">
          <input id="homeEmail" name="email" type="email" placeholder="Email" data-i18n-placeholder="home.login.email" />
          <input id="homePass"  name="password" type="password" placeholder="Password" data-i18n-placeholder="home.login.password" />
        </div>

        <div class="row" style="margin-top:8px;">
          <label class="chk">
            <input id="rememberMe" type="checkbox"/>
            <span data-i18n="home.login.remember">Ricordami su questo dispositivo</span>
          </label>
        </div>

        <div class="row" style="margin-top:8px; gap:12px;">
          <button id="homeSignIn" class="btn" type="submit" data-i18n="home.login.signin">Entra</button>
          <button id="homeSignUp" class="btn" type="button" data-i18n="home.login.signup">Registrati</button>
        </div>

        <div id="homeStatus" class="muted" style="margin-top:6px;"></div>
      </form>
    </section>
  </div>
</div>

<script>
  const $ = (s)=>document.querySelector(s);
  const fraseEl    = $('#frase');
  const imgMago    = $('#imgMago');
  const fumetto    = $('#fumetto');
  const loginPanel = $('#loginPanel');
  const loginForm  = $('#loginForm');
  const homeEmail  = $('#homeEmail');
  const homePass   = $('#homePass');
  const rememberMe = $('#rememberMe');
  const homeSignUp = $('#homeSignUp');
  const homeStatus = $('#homeStatus');

  document.addEventListener('DOMContentLoaded', ()=>{
    requestAnimationFrame(()=> imgMago.classList.add('img-in'));
    setTimeout(()=> fumetto.classList.add('fumetto-in'), 1200);
  });

  function applyI18n(){
    window.i18n?.apply?.(document);
    try {
      const lang = (window.i18n?.getLang && window.i18n.getLang()) || localStorage.getItem('custode.lang') || 'it';
      document.documentElement.setAttribute('lang', lang);
    } catch {}
    if (window.i18n?.t) document.title = window.i18n.t('home.page_title') || 'Il Custode — Home';
    if (window.i18n?.pick) fraseEl.textContent = window.i18n.pick('home.greetings') || '';
  }
  document.addEventListener('i18n:change', applyI18n);

  const LS_REMEMBER_ON='custode.remember.on', LS_REMEMBER_MAIL='custode.remember.email', LS_REMEMBER_PASS='custode.remember.pass';
  function loadRemembered(){
    try{
      const on = localStorage.getItem(LS_REMEMBER_ON) === '1';
      rememberMe.checked = on;
      if (on) {
        homeEmail.value = localStorage.getItem(LS_REMEMBER_MAIL) || '';
        homePass.value  = localStorage.getItem(LS_REMEMBER_PASS) || '';
      }
    }catch{}
  }
  function saveRemembered(){
    try{
      if (rememberMe.checked){
        localStorage.setItem(LS_REMEMBER_ON,'1');
        localStorage.setItem(LS_REMEMBER_MAIL,(homeEmail.value||'').trim());
        localStorage.setItem(LS_REMEMBER_PASS, homePass.value||'');
      } else {
        localStorage.removeItem(LS_REMEMBER_ON);
        localStorage.removeItem(LS_REMEMBER_MAIL);
        localStorage.removeItem(LS_REMEMBER_PASS);
      }
    }catch{}
  }

  function goMenu(){ try{ location.replace('./menu.html'); }catch{ location.href='./menu.html'; } }

  async function waitForSupabase(timeoutMs=8000){
    const t0 = Date.now();
    while (!window.supabaseClient){
      await new Promise(r=>setTimeout(r,50));
      if (Date.now()-t0 > timeoutMs) throw new Error('Supabase non inizializzato');
    }
    return window.supabaseClient;
  }

  let supabaseClient;
  async function redirectIfLogged(){
    try{
      const { data:{ session } = {} } = await supabaseClient.auth.getSession();
      if (session){ goMenu(); return true; }
      return false;
    }catch{ return false; }
  }

  loginForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const email=(homeEmail.value||'').trim(), pass=(homePass.value||'').trim();
    if(!email||!pass){ homeStatus.textContent = (window.i18n?.t?.('home.login.status.fill_both') || ''); return; }
    homeStatus.textContent = (window.i18n?.t?.('home.login.status.signing_in') || '');
    saveRemembered();
    const { error } = await supabaseClient.auth.signInWithPassword({ email, password:pass });
    if(error){ homeStatus.textContent = (window.i18n?.t?.('home.login.status.error_login_prefix') || '') + (error.message||''); return; }
    homeStatus.textContent = (window.i18n?.t?.('home.login.status.ok') || '');
    goMenu();
  });

  homeSignUp.addEventListener('click', async ()=>{
    const email=(homeEmail.value||'').trim(), pass=(homePass.value||'').trim();
    if(!email||!pass){ homeStatus.textContent = (window.i18n?.t?.('home.login.status.fill_both') || ''); return; }
    homeStatus.textContent = (window.i18n?.t?.('home.login.status.registering') || '');
    saveRemembered();
    const { error } = await supabaseClient.auth.signUp({ email, password:pass });
    if(error){ homeStatus.textContent = (window.i18n?.t?.('home.login.status.error_signup_prefix') || '') + (error.message||''); return; }
    homeStatus.textContent = (window.i18n?.t?.('home.login.status.registered') || '');
  });

  (async function boot(){
    try { window.scrollTo(0,0); } catch {}
    applyI18n();
    loadRemembered();
    try { homeEmail.focus({ preventScroll:true }); } catch { try { homeEmail.focus(); } catch {} }

    try { supabaseClient = await waitForSupabase(); }
    catch { homeStatus.textContent = 'Errore: Supabase non disponibile.'; return; }

    const already = await redirectIfLogged();
    if (!already) loginPanel.style.display = '';
  })();
</script>
</body>
</html>
